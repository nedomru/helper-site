---
import Base from "@/layouts/Base.astro";

interface GitHubRelease {
  tag_name: string;
  name: string;
  body: string | null;
  html_url: string;
  published_at: string;
  prerelease: boolean;
}

let changelog: GitHubRelease[] = [];

try {
  const response = await fetch("https://api.github.com/repos/nedomru/helper-site/releases", {
    headers: {
      Accept: "application/vnd.github.v3+json",
    },
  });
  if (response.ok) {
    changelog = await response.json();
  }
} catch (error) {
  console.error("Failed to fetch changelog:", error);
}

function formatDate(dateString: string): string {
  const date = new Date(dateString);
  return date.toLocaleDateString("ru-RU", {
    year: "numeric",
    month: "long",
    day: "numeric",
  });
}

function formatBody(body: string | null): string {
  if (!body) return "Нет описания";
  // Simple markdown-like formatting
  return body
    .replace(/\n/g, "<br>")
    .replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>")
    .replace(/`(.*?)`/g, "<code>$1</code>");
}
---

<Base>
  <h1>Хелпер</h1>
  <p>Расширение для браузера, упрощающее и оптимизирующее твою работу.</p>

  <h2>Установка</h2>
  <p>
    Нажми кнопку ниже для установки последней версии расширения:
  </p>

  <p>
    <a
      href="https://github.com/nedomru/helper-site/releases/latest/download/domhelper.xpi"
      style="display: inline-block; padding: 0.75rem 1.5rem; background: #000; color: #fff; text-decoration: none; border-radius: 4px; font-weight: bold;"
    >
      Установить
    </a>
  </p>

  <h2>Сообщество</h2>
  <p>
    Мы любим общаться, у нас есть закрытая тусовка в Telegram.
    Заходи к нам на огонек, тебе понравится :)
  </p>
  <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
    <a
      href="https://t.me/+jH1mblw0ytcwOWUy"
      style="display: inline-block; padding: 0.5rem 1rem; background: #0088cc; color: #fff; text-decoration: none; border-radius: 6px;"
    >
      Канал
    </a>
    <a
      href="https://t.me/+2vVZ0vXJiWFkOWZi"
      style="display: inline-block; padding: 0.5rem 1rem; background: #0088cc; color: #fff; text-decoration: none; border-radius: 6px;"
    >
      Чат
    </a>
  </div>

  <hr style="margin: 2rem 0; border: none; border-top: 1px solid #ccc;" />

  <h2>История версий</h2>
  {changelog.length > 0 ? (
    <div style="display: flex; flex-direction: column; gap: 1.5rem;">
      {changelog.map((entry) => (
        <div style="padding: 1rem; border: 1px solid #ddd; border-radius: 4px;">
          <div style="margin-bottom: 0.5rem;">
            <h3 style="margin: 0; font-size: 1.1rem;">
              {entry.name || entry.tag_name}
              {entry.prerelease && (
                <span style="margin-left: 0.5rem; padding: 0.2rem 0.5rem; background: #fff3cd; color: #856404; font-size: 0.8rem; border-radius: 4px;">
                  Предварительная версия
                </span>
              )}
            </h3>
            <small style="color: #666;">{formatDate(entry.published_at)}</small>
          </div>
          <div style="margin-top: 0.5rem; line-height: 1.5;" set:html={formatBody(entry.body)} />
        </div>
      ))}
    </div>
  ) : (
    <p style="color: #666;">Не удалось загрузить историю версий.</p>
  )}
</Base>
