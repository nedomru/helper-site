---
import Base from "@/layouts/Base.astro";

interface GitHubRelease {
  tag_name: string;
  name: string;
  body: string | null;
  html_url: string;
  published_at: string;
  prerelease: boolean;
}

let changelog: GitHubRelease[] = [];

try {
  const response = await fetch("https://api.github.com/repos/nedomru/helper-site/releases", {
    headers: {
      Accept: "application/vnd.github.v3+json",
    },
  });
  if (response.ok) {
    changelog = await response.json();
  }
} catch (error) {
  console.error("Failed to fetch changelog:", error);
}

// Find latest beta release
const latestBeta = changelog.find((release) => release.prerelease);

function formatDate(dateString: string): string {
  const date = new Date(dateString);
  return date.toLocaleDateString("ru-RU", {
    year: "numeric",
    month: "long",
    day: "numeric",
  });
}

function formatBody(body: string | null): string {
  if (!body) return "–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è";
  // Simple markdown-like formatting
  return body
    .replace(/\n/g, "<br>")
    .replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>")
    .replace(/`(.*?)`/g, "<code>$1</code>");
}
---

<Base>
  <h1>–•–µ–ª–ø–µ—Ä</h1>
  <p>–†–∞—Å—à–∏—Ä–µ–Ω–∏–µ –¥–ª—è –±—Ä–∞—É–∑–µ—Ä–∞, —É–ø—Ä–æ—â–∞—é—â–µ–µ –∏ –æ–ø—Ç–∏–º–∏–∑–∏—Ä—É—é—â–µ–µ —Ç–≤–æ—é —Ä–∞–±–æ—Ç—É.</p>

  <h2>–£—Å—Ç–∞–Ω–æ–≤–∫–∞</h2>
  <p>
    –ù–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–π —Å—Ç–∞–±–∏–ª—å–Ω–æ–π –≤–µ—Ä—Å–∏–∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è:
  </p>

  <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 1rem;">
    <a
      href="https://github.com/nedomru/helper-site/releases/latest/download/domhelper.xpi"
      style="display: inline-block; padding: 0.75rem 1.5rem; background: #000; color: #fff; text-decoration: none; border-radius: 4px; font-weight: bold;"
    >
      üõ°Ô∏è –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å (Stable)
    </a>

    {latestBeta && (
      <a
        href={`https://github.com/nedomru/helper-site/releases/${latestBeta.tag_name}/download/domhelper.xpi`}
        style="display: inline-block; padding: 0.75rem 1.5rem; background: #8b5cf6; color: #fff; text-decoration: none; border-radius: 4px; font-weight: bold;"
      >
        üß™ –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å (Beta {latestBeta.tag_name})
      </a>
    )}
  </div>

  {latestBeta && (
    <p style="font-size: 0.85rem; color: #666;">
      ‚ö†Ô∏è –ë–µ—Ç–∞-–≤–µ—Ä—Å–∏—è –º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å –æ—à–∏–±–∫–∏. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –Ω–∞ —Å–≤–æ–π —Ä–∏—Å–∫.
    </p>
  )}

  <h2>–°–æ–æ–±—â–µ—Å—Ç–≤–æ</h2>
  <p>
    –ú—ã –ª—é–±–∏–º –æ–±—â–∞—Ç—å—Å—è, —É –Ω–∞—Å –µ—Å—Ç—å –∑–∞–∫—Ä—ã—Ç–∞—è —Ç—É—Å–æ–≤–∫–∞ –≤ Telegram.
    –ó–∞—Ö–æ–¥–∏ –∫ –Ω–∞–º –Ω–∞ –æ–≥–æ–Ω–µ–∫, —Ç–µ–±–µ –ø–æ–Ω—Ä–∞–≤–∏—Ç—Å—è :)
  </p>
  <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
    <a
      href="https://t.me/+jH1mblw0ytcwOWUy"
      style="display: inline-block; padding: 0.5rem 1rem; background: #0088cc; color: #fff; text-decoration: none; border-radius: 6px;"
    >
      –ö–∞–Ω–∞–ª
    </a>
    <a
      href="https://t.me/+2vVZ0vXJiWFkOWZi"
      style="display: inline-block; padding: 0.5rem 1rem; background: #0088cc; color: #fff; text-decoration: none; border-radius: 6px;"
    >
      –ß–∞—Ç
    </a>
  </div>

  <hr style="margin: 2rem 0; border: none; border-top: 1px solid #ccc;" />

  <h2>–ò—Å—Ç–æ—Ä–∏—è –≤–µ—Ä—Å–∏–π</h2>
  {changelog.length > 0 ? (
    <div style="display: flex; flex-direction: column; gap: 1.5rem;">
      {changelog.map((entry) => (
        <div style="padding: 1rem; border: 1px solid #ddd; border-radius: 4px;">
          <div style="margin-bottom: 0.5rem;">
            <h3 style="margin: 0; font-size: 1.1rem;">
              {entry.name || entry.tag_name}
              {entry.prerelease && (
                <span style="margin-left: 0.5rem; padding: 0.2rem 0.5rem; background: #fff3cd; color: #856404; font-size: 0.8rem; border-radius: 4px;">
                    –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è
                  </span>
              )}
            </h3>
            <small style="color: #666;">{formatDate(entry.published_at)}</small>
          </div>
          <div style="margin-top: 0.5rem; line-height: 1.5;" set:html={formatBody(entry.body)} />
        </div>
      ))}
    </div>
  ) : (
    <p style="color: #666;">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –≤–µ—Ä—Å–∏–π.</p>
  )}
</Base>
